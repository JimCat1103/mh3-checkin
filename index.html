<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MH3 Check-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">

<div class="w-full max-w-md bg-white rounded-lg shadow-xl p-6 relative min-h-[300px]">

    <div id="initLoader" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center rounded-lg">
        <div class="loader mb-4"></div>
        <p class="text-gray-500 font-medium">ç³»çµ±é€£ç·šä¸­...</p>
    </div>

    <div class="text-center mb-6 border-b pb-4">
        <h1 class="text-2xl font-extrabold text-blue-700 tracking-wider">MH3 Check-in</h1>
        <div id="runInfoDisplay" class="hidden mt-2">
            <h2 id="runTitle" class="text-xl font-bold text-gray-800"></h2>
            <p id="runDate" class="text-sm text-gray-500"></p>
            <p id="runHare" class="text-sm text-gray-500"></p>
        </div>
    </div>

    <div id="waitingSection" class="hidden text-center py-8 fade-in">
        <div class="text-5xl mb-4">â³</div>
        <h3 class="text-xl font-bold text-gray-700 mb-2">æ´»å‹•å°šæœªé–‹å§‹</h3>
        <p class="text-gray-500 mb-4">å ±åè¡¨å°‡æ–¼æ´»å‹•ç•¶æ—¥ 19:00 é–‹æ”¾</p>
        <p class="text-sm bg-gray-100 p-2 rounded">ä¸‹ä¸€æ¬¡æ´»å‹•ï¼š<span id="waitDate" class="font-bold"></span></p>
    </div>

    <div id="thankYouSection" class="hidden text-center py-8 fade-in">
        <div class="text-5xl mb-4">ğŸ‰</div>
        <h3 class="text-xl font-bold text-green-700 mb-2">æ´»å‹•å·²å®Œæˆ</h3>
        <p class="text-gray-600 mb-6">æ„Ÿè¬æ‚¨çš„åƒåŠ ï¼è«‹æœŸå¾…ä¸‹ä¸€æ¬¡çš„ Hashã€‚</p>
        <div class="p-4 bg-blue-50 rounded-lg text-sm text-blue-800">
            è¨˜å¾—è®“è‡ªå·±ä¿æŒæ°´åˆ†ï¼Œä¸‹é€±è¦‹ï¼<br>
            On On!
        </div>
        <button onclick="debugReset()" class="mt-8 text-xs text-gray-300 hover:text-gray-500">é‡ç½®ç‹€æ…‹ (Debug)</button>
    </div>

    <div id="backSection" class="hidden p-2 fade-in">
        <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center shadow-sm">
            <div class="text-3xl mb-2">ğŸƒâ€â™‚ï¸</div>
            <p class="font-bold text-lg text-green-800">å ±åˆ°æˆåŠŸï¼Enjoy the Run!</p>
            <div class="mt-2 text-sm text-gray-600">
                <p>è·‘æ¬¡: <span id="statusRunNum" class="font-bold"></span></p>
                <p>å§“å: <span id="savedName"></span></p>
            </div>
        </div>

        <button onclick="doBack()" class="mt-6 w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-xl hover:bg-blue-700 shadow-lg transform transition active:scale-95">
            ğŸ  æˆ‘å›ä¾†äº† (I'm Back)
        </button>

        <button onclick="resetForm()" class="mt-4 w-full text-center text-gray-400 text-sm underline hover:text-gray-600">
            å¹«åˆ¥äººå ±åˆ° / é‡æ–°è¼¸å…¥
        </button>
    </div>

    <div id="formSection" class="hidden fade-in">
        <div class="mb-4">
            <label class="block text-gray-700 font-bold mb-2">æ‚¨çš„è³‡æ–™ (Main)</label>
            <input type="text" id="mainName" placeholder="å§“å / Name (å¿…å¡«)" class="w-full p-3 border rounded-lg mb-3 bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition">
            <input type="tel" id="mainPhone" placeholder="é›»è©± / Phone (å¿…å¡«)" class="w-full p-3 border rounded-lg mb-3 bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition">
            <div class="flex items-center p-3 bg-gray-50 rounded cursor-pointer" onclick="document.getElementById('mainBash').click()">
                <input type="checkbox" id="mainBash" class="mr-3 h-5 w-5 text-blue-600 cursor-pointer">
                <label for="mainBash" class="text-gray-700 select-none cursor-pointer">åƒåŠ èšé¤ (Bash)?</label>
            </div>
        </div>

        <div id="buddyList" class="space-y-3 mb-6"></div>

        <button onclick="addBuddy()" class="w-full border-2 border-dashed border-gray-300 text-gray-500 py-2 rounded-lg mb-6 hover:border-blue-400 hover:text-blue-500 transition">
            + æ–°å¢åŒä¼´ (Add Buddy)
        </button>

        <button onclick="submitForm()" id="submitBtn" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold text-xl hover:bg-green-700 shadow-md transition transform active:scale-95">
            é€å‡ºå ±åˆ° (Check In)
        </button>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center">
            <div class="loader mb-3"></div>
            <span class="font-bold text-gray-700">è³‡æ–™è™•ç†ä¸­...</span>
        </div>
    </div>
</div>

<script>
  // ================= è¨­å®šå€ =================
  const API_URL = 'https://script.google.com/macros/s/AKfycbxmkQakubfwGK2ZRoEL1_Z3BXixcFLuGQDMZcp2Fml8a9uvxBV-L4e5KOTx-8K5uIm5Sw/exec';
  // =========================================

  let currentRunInfo = {};

  window.onload = async function() {
    try {
      // 1. å–å¾—è·‘æ¬¡èˆ‡ç‹€æ…‹
      const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({action: 'getInfo'})
      });
      const data = await response.json();
      currentRunInfo = data.info; // {number, hare, dateStr}
      const status = data.status; // 'waiting', 'open'

      // é¡¯ç¤ºæ¨™é¡Œè³‡è¨Š
      document.getElementById('runTitle').innerText = `Run #${currentRunInfo.number}`;
      document.getElementById('runDate').innerText = currentRunInfo.dateStr;
      document.getElementById('runHare').innerText = `Hare: ${currentRunInfo.hare}`;
      document.getElementById('waitDate').innerText = currentRunInfo.dateStr;

      document.getElementById('initLoader').classList.add('hidden');

      // 2. ä¾ç…§ç‹€æ…‹åˆ†æµ
      if (status === 'waiting') {
        showSection('waitingSection');
      } else {
        // æ´»å‹•é–‹æ”¾ä¸­ï¼Œé¡¯ç¤ºæ¨™é¡Œä¸¦æª¢æŸ¥æœ¬åœ°å„²å­˜
        document.getElementById('runInfoDisplay').classList.remove('hidden');
        checkLocalStorage(currentRunInfo.number);
      }

    } catch (e) {
      alert('ç³»çµ±é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error(e);
      document.getElementById('initLoader').classList.add('hidden');
    }
  };

  function checkLocalStorage(serverRunNumber) {
    const savedData = localStorage.getItem('mh3_user');

    if (savedData) {
      const user = JSON.parse(savedData);

      // æª¢æŸ¥æ˜¯å¦éæœŸ
      if (user.lastRunNumber != serverRunNumber) {
        // éæœŸäº† -> æ¸…é™¤ç‹€æ…‹ï¼Œé€²å…¥å ±åæ¨¡å¼ (è²¼å¿ƒä¿ç•™å§“åé›»è©±)
        console.log('æ–°æ´»å‹•ï¼Œé‡ç½®ç‹€æ…‹');
        document.getElementById('mainName').value = user.name;
        document.getElementById('mainPhone').value = user.phone;
        showSection('formSection');
      } else {
        // æ˜¯åŒä¸€å ´æ´»å‹•ï¼Œæª¢æŸ¥æ˜¯å¦å·²ç¶“ Back é
        if (user.status === 'completed') {
          showSection('thankYouSection');
        } else {
          // é‚„æ²’ Back -> é¡¯ç¤º Back ç•«é¢
          document.getElementById('savedName').innerText = user.name;
          document.getElementById('statusRunNum').innerText = `#${user.lastRunNumber}`;
          showSection('backSection');
        }
      }
    } else {
      showSection('formSection');
    }
  }

  // é¡¯ç¤ºç‰¹å®šå€å¡Šï¼Œéš±è—å…¶ä»–
  function showSection(id) {
    ['waitingSection', 'thankYouSection', 'backSection', 'formSection'].forEach(sec => {
      document.getElementById(sec).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
  }

  function addBuddy() {
    const div = document.createElement('div');
    div.className = "mb-2 border-l-4 border-blue-300 pl-3 bg-gray-50 p-3 rounded relative fade-in";
    div.innerHTML = `
            <button onclick="this.parentElement.remove()" class="absolute top-1 right-2 text-red-400 hover:text-red-600 font-bold">âœ•</button>
            <input type="text" class="buddy-name w-full p-2 border rounded mb-2" placeholder="åŒä¼´å§“å">
            <div class="flex items-center cursor-pointer">
                <input type="checkbox" class="buddy-bash mr-2 h-5 w-5 cursor-pointer">
                <label class="text-sm text-gray-600 cursor-pointer">åƒåŠ èšé¤?</label>
            </div>
        `;
    document.getElementById('buddyList').appendChild(div);
  }

  function submitForm() {
    const mainName = document.getElementById('mainName').value.trim();
    const mainPhone = document.getElementById('mainPhone').value.trim();
    const mainBash = document.getElementById('mainBash').checked;

    if (!mainName || !mainPhone) { alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½'); return; }

    const users = [];
    users.push({name: mainName, phone: mainPhone, bash: mainBash, coverBy: 'Self'});

    document.querySelectorAll('#buddyList > div').forEach(div => {
      const bName = div.querySelector('.buddy-name').value.trim();
      const bBash = div.querySelector('.buddy-bash').checked;
      if(bName) users.push({name: bName, phone: mainPhone, bash: bBash, coverBy: mainName});
    });

    const payload = {
      action: 'checkin',
      runNumber: currentRunInfo.number,
      users: users
    };

    sendData(payload, () => {
      // å„²å­˜ç‹€æ…‹
      localStorage.setItem('mh3_user', JSON.stringify({
        name: mainName,
        phone: mainPhone,
        bash: mainBash, // è¨˜ä½ Bash é¸æ“‡ï¼Œæ–¹ä¾¿ Back æ™‚åˆ¤æ–·
        lastRunNumber: currentRunInfo.number,
        status: 'checked_in'
      }));

      alert('å ±åˆ°æˆåŠŸï¼');
      checkLocalStorage(currentRunInfo.number); // æœƒè‡ªå‹•è·³åˆ° Back ç•«é¢
    });
  }

  function doBack() {
    const savedData = JSON.parse(localStorage.getItem('mh3_user'));
    if(!savedData) return;

    // --- Feedback 3: è©¢å•æ˜¯å¦è£œ Bash ---
    let wantJoinBash = false;

    // åªæœ‰ç•¶åˆæ²’å‹¾ Bash çš„äººæ‰å•
    if (savedData.bash === false) {
      wantJoinBash = confirm(`è¾›è‹¦äº†ï¼\næ‚¨ç•¶åˆå ±åˆ°æ™‚ã€Œæ²’æœ‰ã€ç™»è¨˜èšé¤ (Bash)ã€‚\n\nè«‹å•ç¾åœ¨è¦åŠ å…¥ Bash å—ï¼Ÿ`);
    } else {
      // åŸæœ¬æœ‰å‹¾çš„ï¼Œå†æ¬¡ç¢ºèªå®‰å…¨å›ä¾†å³å¯
      if(!confirm(`ç¢ºèª ${savedData.name} èˆ‡å…¶åŒä¼´éƒ½å·²å®‰å…¨è¿”å›ï¼Ÿ`)) return;
    }

    const payload = {
      action: 'back',
      runNumber: currentRunInfo.number,
      phone: savedData.phone,
      joinBash: wantJoinBash // å‚³é€è£œç™»æ„é¡˜
    };

    sendData(payload, () => {
      // æ›´æ–°æœ¬åœ°ç‹€æ…‹ç‚ºå·²å®Œæˆ
      savedData.status = 'completed';
      localStorage.setItem('mh3_user', JSON.stringify(savedData));

      // --- Feedback 4: é¡¯ç¤ºæ„Ÿè¬ç•«é¢ ---
      showSection('thankYouSection');
    });
  }

  // é‡æ–°å ±åˆ° (ä¿ç•™è³‡æ–™ä½†ä¸é–å®š)
  function resetForm() {
    const savedData = JSON.parse(localStorage.getItem('mh3_user') || '{}');
    // æ¸…é™¤ç‹€æ…‹ï¼Œä¿ç•™å§“åé›»è©±æ–¹ä¾¿é‡å¡«
    localStorage.setItem('mh3_user', JSON.stringify({
      name: savedData.name || '',
      phone: savedData.phone || '',
      lastRunNumber: 'reset'
    }));
    location.reload();
  }

  function debugReset() {
    localStorage.removeItem('mh3_user');
    location.reload();
  }

  function sendData(payload, onSuccess) {
    document.getElementById('loading').classList.remove('hidden');
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    })
      .then(res => res.json())
      .then(data => {
        document.getElementById('loading').classList.add('hidden');
        if(data.result === 'success') {
          onSuccess();
        } else {
          alert('éŒ¯èª¤ï¼š' + (data.msg || 'æœªçŸ¥éŒ¯èª¤'));
        }
      })
      .catch(err => {
        console.error(err);
        alert('é€£ç·šå¤±æ•—');
        document.getElementById('loading').classList.add('hidden');
      });
  }
</script>
</body>
</html>