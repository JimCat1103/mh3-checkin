<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MH3 Check-in</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dark Mode Loader */
        .loader { border: 4px solid #334155; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-enter { animation: modalIn 0.3s ease-out; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* è‡ªå®šç¾© Checkbox æ¨£å¼å„ªåŒ– */
        input[type="checkbox"] { accent-color: #2563eb; }
    </style>
</head>
<body class="bg-slate-900 min-h-screen p-4 flex items-center justify-center font-sans text-slate-200">

<div class="w-full max-w-md bg-slate-800 rounded-xl shadow-2xl p-6 relative min-h-[300px] border border-slate-700">

    <div id="initLoader" class="absolute inset-0 bg-slate-800 z-40 flex flex-col items-center justify-center rounded-xl">
        <div class="loader mb-4"></div>
        <p class="text-slate-400 font-medium tracking-wide">ç³»çµ±é€£ç·šä¸­...</p>
    </div>

    <div class="text-center mb-6 border-b border-slate-700 pb-4">
        <h1 class="text-3xl font-extrabold text-blue-500 tracking-wider drop-shadow-lg">MH3 Check-in</h1>
        <div id="runInfoDisplay" class="hidden mt-2 fade-in">
            <h2 id="runTitle" class="text-xl font-bold text-slate-100"></h2>
            <div class="flex justify-center space-x-3 mt-1 text-sm text-slate-400">
                <p id="runDate"></p>
                <span>|</span>
                <p id="runHare"></p>
            </div>
        </div>
    </div>

    <div id="waitingSection" class="hidden text-center py-10 fade-in">
        <div class="text-6xl mb-6 opacity-80">â³</div>
        <h3 class="text-2xl font-bold text-slate-300 mb-2">æ´»å‹•å°šæœªé–‹å§‹</h3>
        <p class="text-slate-500 mb-6">å ±åè¡¨å°‡æ–¼æ´»å‹•ç•¶æ—¥ 19:00 é–‹æ”¾</p>
        <div class="inline-block bg-slate-700 px-4 py-2 rounded-full text-sm font-medium text-slate-300 border border-slate-600">
            ä¸‹ä¸€æ¬¡æ´»å‹•ï¼š<span id="waitDate" class="text-blue-400 font-bold"></span>
        </div>
    </div>

    <div id="thankYouSection" class="hidden text-center py-10 fade-in">
        <div class="text-6xl mb-6 opacity-90">ğŸ‰</div>
        <h3 class="text-2xl font-bold text-green-400 mb-3">æ´»å‹•å·²å®Œæˆ</h3>
        <p class="text-slate-400 mb-8 px-4">æ„Ÿè¬æ‚¨çš„åƒåŠ ï¼è«‹æœŸå¾…ä¸‹ä¸€æ¬¡çš„ Hashã€‚</p>
        <div class="bg-slate-700/50 rounded-lg p-4 text-sm text-blue-300 leading-relaxed mx-2 border border-slate-600">
            <strong>On On!</strong><br>
            è¨˜å¾—è®“è‡ªå·±ä¿æŒæ°´åˆ†ï¼Œä¸‹é€±è¦‹ï¼
        </div>
        <button onclick="debugReset()" class="mt-8 text-xs text-slate-600 hover:text-slate-400 underline transition">é‡ç½®ç‹€æ…‹ (Debug)</button>
    </div>

    <div id="backSection" class="hidden p-2 fade-in">
        <div class="bg-green-900/20 border border-green-800 rounded-xl p-6 text-center shadow-inner">
            <div class="text-4xl mb-3">ğŸƒâ€â™‚ï¸</div>
            <p class="font-bold text-xl text-green-400">å ±åˆ°æˆåŠŸï¼</p>
            <p class="text-green-600 text-sm mb-4">Enjoy the Run!</p>
            <div class="border-t border-green-800/50 pt-3 mt-2 text-sm text-slate-400 space-y-1">
                <p>è·‘æ¬¡: <span id="statusRunNum" class="font-bold text-slate-200"></span></p>
                <p>ä¸»è¦è¯çµ¡äºº: <span id="savedName" class="font-bold text-slate-200"></span></p>
                <p id="buddyCountDisplay" class="text-slate-500 text-xs hidden"></p>
            </div>
        </div>

        <button onclick="preBackCheck()" class="mt-6 w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-blue-500 hover:shadow-blue-900/50 shadow-lg transform transition active:scale-95 flex items-center justify-center">
            <span>ğŸ  æˆ‘å›ä¾†äº† (I'm Back)</span>
        </button>

        <button onclick="resetForm()" class="mt-4 w-full text-center text-slate-500 text-sm hover:text-slate-300 transition">
            å¹«åˆ¥äººå ±åˆ° / é‡æ–°è¼¸å…¥
        </button>
    </div>

    <div id="formSection" class="hidden fade-in">
        <div class="bg-slate-700/40 p-4 rounded-xl mb-6 border border-slate-700">
            <h3 class="text-blue-400 font-bold mb-3 flex items-center">
                <span class="mr-2">ğŸ‘¤</span> æ‚¨çš„è³‡æ–™ (Main)
            </h3>
            <input type="text" id="mainName" placeholder="å§“å / Name (å¿…å¡«)" class="w-full p-3 border border-slate-600 rounded-lg mb-3 bg-slate-800 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
            <input type="tel" id="mainPhone" placeholder="é›»è©± / Phone (å¿…å¡«)" class="w-full p-3 border border-slate-600 rounded-lg mb-3 bg-slate-800 text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">

            <label class="flex items-center p-3 bg-slate-800 rounded-lg border border-slate-600 cursor-pointer hover:border-blue-500 hover:shadow-md transition select-none group">
                <input type="checkbox" id="mainBash" class="mr-3 h-5 w-5 rounded focus:ring-blue-500 cursor-pointer bg-slate-700 border-slate-500">
                <span class="text-slate-300 font-medium flex-1 group-hover:text-blue-300 transition">åƒåŠ èšé¤ (Bash)?</span>
            </label>
        </div>

        <div id="buddyList" class="space-y-3 mb-6"></div>

        <button onclick="addBuddy()" class="w-full border-2 border-dashed border-slate-600 text-slate-400 py-3 rounded-xl mb-6 hover:border-blue-500 hover:text-blue-400 hover:bg-slate-700/50 transition font-medium flex items-center justify-center">
            <span class="mr-1">+</span> æ–°å¢åŒä¼´ (Add Buddy)
        </button>

        <button onclick="submitForm()" id="submitBtn" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-xl hover:bg-green-500 hover:shadow-green-900/50 shadow-lg transition transform active:scale-95 flex items-center justify-center">
            é€å‡ºå ±åˆ° (Check In)
        </button>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-slate-900 bg-opacity-80 flex justify-center items-center z-50 backdrop-blur-sm fade-in">
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl flex flex-col items-center transform scale-110 border border-slate-700">
            <div class="loader mb-3"></div>
            <span class="font-bold text-slate-300">è³‡æ–™è™•ç†ä¸­...</span>
        </div>
    </div>

    <div id="customModal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm relative z-10 overflow-hidden modal-enter border border-slate-700">
            <div class="p-6 text-center">
                <div id="modalIcon" class="text-4xl mb-4">â„¹ï¸</div>
                <h3 id="modalTitle" class="text-xl font-bold text-white mb-2">æç¤º</h3>

                <div id="modalContentContainer" class="text-left mb-6">
                    <p id="modalMessage" class="text-slate-400 text-sm leading-relaxed text-center">å…§å®¹...</p>
                    <div id="modalDynamicContent" class="mt-4 space-y-2"></div>
                </div>

                <div id="modalButtons" class="flex space-x-3 justify-center">
                </div>
            </div>
        </div>
    </div>

</div>

<script>
  // ================= è¨­å®šå€ =================
  const API_URL = 'https://script.google.com/macros/s/AKfycbxmkQakubfwGK2ZRoEL1_Z3BXixcFLuGQDMZcp2Fml8a9uvxBV-L4e5KOTx-8K5uIm5Sw/exec';
  // =========================================

  let currentRunInfo = {};
  let currentGroup = [];

  function showModal({title, msg, type = 'alert', confirmCallback = null, cancelCallback = null, dynamicContent = null}) {
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalMessage').innerText = msg || '';

    const dynamicContainer = document.getElementById('modalDynamicContent');
    dynamicContainer.innerHTML = '';
    if (dynamicContent) {
      dynamicContainer.appendChild(dynamicContent);
    }

    const btnContainer = document.getElementById('modalButtons');
    btnContainer.innerHTML = '';

    const icon = document.getElementById('modalIcon');

    if (type === 'confirm') {
      icon.innerText = 'ğŸ¤”';
      const cancelBtn = document.createElement('button');
      cancelBtn.className = "flex-1 bg-slate-700 text-slate-300 py-2 rounded-lg font-bold hover:bg-slate-600 transition border border-slate-600";
      cancelBtn.innerText = "å–æ¶ˆ";
      cancelBtn.onclick = () => {
        closeModal();
        if (cancelCallback) cancelCallback();
      };

      const okBtn = document.createElement('button');
      okBtn.className = "flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-500 transition shadow-lg shadow-blue-900/30";
      okBtn.innerText = "ç¢ºå®š";
      okBtn.onclick = () => {
        closeModal();
        if (confirmCallback) confirmCallback();
      };

      btnContainer.appendChild(cancelBtn);
      btnContainer.appendChild(okBtn);
    } else {
      icon.innerText = (title.includes('éŒ¯èª¤') || title.includes('å¤±æ•—') || title.includes('ä¸å®Œæ•´')) ? 'âŒ' : 'âœ…';
      const okBtn = document.createElement('button');
      okBtn.className = "w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-500 transition shadow-lg shadow-blue-900/30";
      okBtn.innerText = "å¥½ï¼Œæˆ‘çŸ¥é“äº†";
      okBtn.onclick = () => {
        closeModal();
        if (confirmCallback) confirmCallback();
      };
      btnContainer.appendChild(okBtn);
    }

    document.getElementById('customModal').classList.remove('hidden');
  }

  function closeModal() {
    document.getElementById('customModal').classList.add('hidden');
  }

  window.onload = async function() {
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({action: 'getInfo'})
      });
      const data = await response.json();
      currentRunInfo = data.info;
      const status = data.status;

      document.getElementById('runTitle').innerText = `Run ${currentRunInfo.number}`;
      document.getElementById('runDate').innerText = currentRunInfo.dateStr;
      document.getElementById('runHare').innerText = `Hare: ${currentRunInfo.hare}`;
      document.getElementById('waitDate').innerText = currentRunInfo.dateStr;

      document.getElementById('initLoader').classList.add('hidden');

      if (status === 'waiting') {
        showSection('waitingSection');
      } else {
        document.getElementById('runInfoDisplay').classList.remove('hidden');
        checkLocalStorage(currentRunInfo.number);
      }

    } catch (e) {
      showModal({title: 'é€£ç·šéŒ¯èª¤', msg: 'ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚'});
      console.error(e);
      document.getElementById('initLoader').classList.add('hidden');
    }
  };

  function checkLocalStorage(serverRunNumber) {
    const savedGroupJson = localStorage.getItem('mh3_group');
    if (!savedGroupJson && localStorage.getItem('mh3_user')) {
      localStorage.removeItem('mh3_user');
    }

    if (savedGroupJson) {
      const groupData = JSON.parse(savedGroupJson);
      if (groupData.runNumber != serverRunNumber) {
        console.log('æ–°æ´»å‹•ï¼Œè‡ªå‹•å¸¶å…¥ä¸Šæ¬¡è³‡æ–™');
        const mainUser = groupData.users[0];
        document.getElementById('mainName').value = mainUser.name || '';
        document.getElementById('mainPhone').value = mainUser.phone || '';
        document.getElementById('buddyList').innerHTML = '';
        for (let i = 1; i < groupData.users.length; i++) {
          const buddy = groupData.users[i];
          addBuddy(buddy.name, buddy.phone);
        }
        showSection('formSection');
      } else {
        currentGroup = groupData.users;
        if (groupData.status === 'completed') {
          showSection('thankYouSection');
        } else {
          const mainUser = currentGroup[0];
          document.getElementById('savedName').innerText = mainUser.name;
          document.getElementById('statusRunNum').innerText = `#${groupData.runNumber}`;

          if (currentGroup.length > 1) {
            const display = document.getElementById('buddyCountDisplay');
            display.innerText = `(+ ${currentGroup.length - 1} ä½åŒä¼´)`;
            display.classList.remove('hidden');
          }
          showSection('backSection');
        }
      }
    } else {
      showSection('formSection');
    }
  }

  function showSection(id) {
    ['waitingSection', 'thankYouSection', 'backSection', 'formSection'].forEach(sec => {
      document.getElementById(sec).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
  }

  function addBuddy(name = '', phone = '') {
    const div = document.createElement('div');
    div.className = "mb-3 bg-slate-800 p-3 rounded-xl border border-slate-700 relative fade-in shadow-sm";
    div.innerHTML = `
            <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-slate-500 hover:text-red-400 font-bold p-1 transition">âœ•</button>
            <h4 class="text-xs font-bold text-slate-500 mb-2 uppercase">Buddy</h4>
            <input type="text" class="buddy-name w-full p-2 border border-slate-600 rounded-lg mb-2 bg-slate-900 text-white placeholder-slate-500 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="åŒä¼´å§“å" value="${name}">
            <input type="tel" class="buddy-phone w-full p-2 border border-slate-600 rounded-lg mb-2 bg-slate-900 text-white placeholder-slate-500 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="åŒä¼´é›»è©± (é¸å¡«)" value="${phone}">
            <label class="flex items-center p-2 bg-slate-900 rounded-lg border border-slate-600 cursor-pointer hover:border-blue-500 transition select-none group">
                <input type="checkbox" class="buddy-bash mr-2 h-4 w-4 rounded cursor-pointer bg-slate-800 border-slate-500">
                <span class="text-sm text-slate-400 cursor-pointer flex-1 group-hover:text-blue-300 transition">åƒåŠ èšé¤?</span>
            </label>
        `;
    document.getElementById('buddyList').appendChild(div);
  }

  function submitForm() {
    const mainName = document.getElementById('mainName').value.trim();
    const mainPhone = document.getElementById('mainPhone').value.trim();
    const mainBash = document.getElementById('mainBash').checked;

    if (!mainName || !mainPhone) {
      showModal({title: 'è³‡æ–™ä¸å®Œæ•´', msg: 'è«‹å¡«å¯« Main çš„ã€Œå§“åã€èˆ‡ã€Œé›»è©±ã€'});
      return;
    }

    const users = [];
    users.push({name: mainName, phone: mainPhone, bash: mainBash, coverBy: 'Self'});

    document.querySelectorAll('#buddyList > div').forEach(div => {
      const bName = div.querySelector('.buddy-name').value.trim();
      const bPhoneInput = div.querySelector('.buddy-phone').value.trim();
      const bPhone = bPhoneInput || mainPhone;

      const bBash = div.querySelector('.buddy-bash').checked;
      if(bName) {
        users.push({name: bName, phone: bPhone, bash: bBash, coverBy: mainName});
      }
    });

    const payload = {
      action: 'checkin',
      runNumber: currentRunInfo.number,
      users: users
    };

    sendData(payload, () => {
      const storageData = {
        runNumber: currentRunInfo.number,
        status: 'checked_in',
        users: users
      };
      localStorage.setItem('mh3_group', JSON.stringify(storageData));

      showModal({title: 'å ±åˆ°æˆåŠŸ', msg: 'ç¥æ‚¨è·‘æ­¥æ„‰å¿«ï¼On On!', type: 'success', confirmCallback: () => {
          checkLocalStorage(currentRunInfo.number);
        }});
    });
  }

  function preBackCheck() {
    const nonBashers = currentGroup.filter(u => u.bash === false);

    if (nonBashers.length > 0) {
      const container = document.createElement('div');
      container.className = "flex flex-col space-y-2 max-h-40 overflow-y-auto border-t border-b border-slate-600 py-2";

      nonBashers.forEach((u, index) => {
        const label = document.createElement('label');
        label.className = "flex items-center space-x-2 cursor-pointer p-2 hover:bg-slate-700 rounded transition";
        label.innerHTML = `
                  <input type="checkbox" data-idx="${index}" class="bash-è¡¥-check h-4 w-4 rounded bg-slate-900 border-slate-500">
                  <span class="text-sm text-slate-300">${u.name}</span>
              `;
        container.appendChild(label);
      });

      showModal({
        title: 'è£œç™»è¨˜èšé¤ç¢ºèª',
        msg: 'ä»¥ä¸‹äººå“¡æœªç™»è¨˜èšé¤ï¼Œè«‹å•ç¾åœ¨è¦åŠ å…¥å—ï¼Ÿ(è‹¥ç„¡å‰‡ç›´æ¥æŒ‰ç¢ºå®š)',
        type: 'confirm',
        dynamicContent: container,
        confirmCallback: () => {
          const checks = container.querySelectorAll('.bash-è¡¥-check');
          const targets = [];

          currentGroup.filter(u => u.bash === true).forEach(u => {
            targets.push({phone: u.phone, joinBash: true});
          });

          nonBashers.forEach((u, idx) => {
            const isChecked = checks[idx].checked;
            targets.push({phone: u.phone, joinBash: isChecked});
          });

          executeBack(targets);
        }
      });
    } else {
      showModal({
        title: 'å®‰å…¨å›å ±ç¢ºèª',
        msg: `ç¢ºèªå…± ${currentGroup.length} äººçš†å·²å®‰å…¨è¿”å›ï¼Ÿ`,
        type: 'confirm',
        confirmCallback: () => {
          const targets = currentGroup.map(u => ({phone: u.phone, joinBash: true}));
          executeBack(targets);
        }
      });
    }
  }

  function executeBack(targets) {
    const payload = {
      action: 'back',
      runNumber: currentRunInfo.number,
      targets: targets
    };

    sendData(payload, () => {
      const storageData = JSON.parse(localStorage.getItem('mh3_group'));
      storageData.status = 'completed';
      localStorage.setItem('mh3_group', JSON.stringify(storageData));
      showSection('thankYouSection');
    });
  }

  function resetForm() {
    const savedData = localStorage.getItem('mh3_group');
    if (savedData) {
      const data = JSON.parse(savedData);
      data.runNumber = 'reset';
      localStorage.setItem('mh3_group', JSON.stringify(data));
    }
    location.reload();
  }

  function debugReset() {
    localStorage.removeItem('mh3_group');
    location.reload();
  }

  function sendData(payload, onSuccess) {
    document.getElementById('loading').classList.remove('hidden');
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    })
      .then(res => res.json())
      .then(data => {
        document.getElementById('loading').classList.add('hidden');
        if(data.result === 'success') {
          onSuccess();
        } else {
          showModal({title: 'éŒ¯èª¤', msg: data.msg || 'æœªçŸ¥éŒ¯èª¤'});
        }
      })
      .catch(err => {
        console.error(err);
        showModal({title: 'é€£ç·šå¤±æ•—', msg: 'ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œè«‹é‡è©¦'});
        document.getElementById('loading').classList.add('hidden');
      });
  }
</script>
</body>
</html>